<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RifaMax - Sorteos en L√≠nea</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #FFD23F;
            --accent: #00B4D8;
            --dark: #1a1a2e;
            --darker: #0f0f1e;
            --light: #ffffff;
            --success: #06FFA5;
            --danger: #FF5252;
            --purple: #9B5DE5;
            --warning: #FFA726;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .background-dots {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            opacity: 0.1;
            pointer-events: none;
        }

        .dot {
            position: absolute;
            width: 4px; height: 4px;
            background: var(--secondary);
            border-radius: 50%;
            animation: float 20s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); }
            50% { transform: translateY(-60px) translateX(-20px); }
        }

        header {
            position: relative;
            z-index: 10;
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            cursor: pointer;
        }

        nav { display: flex; gap: 1.5rem; align-items: center; }

        nav a {
            color: var(--light);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        nav a:hover { color: var(--secondary); }

        .nav-buttons { display: flex; gap: 0.8rem; align-items: center; }

        .btn-login {
            padding: 0.5rem 1.2rem;
            background: transparent;
            border: 2px solid var(--accent);
            border-radius: 25px;
            color: var(--accent);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .btn-login:hover { background: var(--accent); color: var(--dark); }

        .btn-register {
            padding: 0.5rem 1.2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 25px;
            color: var(--dark);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-menu { position: relative; display: none; }
        .user-menu.active { display: block; }

        .user-avatar {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            cursor: pointer;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--dark);
            font-weight: 600;
            overflow: hidden;
        }

        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .user-dropdown {
            position: absolute;
            top: 55px; right: 0;
            background: var(--dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1rem;
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .user-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }

        .user-dropdown-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 0.5rem;
        }

        .dropdown-avatar {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: 2px solid var(--secondary);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .dropdown-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .dropdown-info h4 { font-size: 1rem; color: var(--secondary); }
        .dropdown-info p { font-size: 0.75rem; opacity: 0.7; }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.7rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .dropdown-item:hover { background: rgba(255, 107, 53, 0.2); }
        .dropdown-item.admin { color: var(--purple); border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 0.5rem; padding-top: 1rem; }
        .dropdown-item.logout { color: var(--danger); border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 0.5rem; padding-top: 1rem; }
        .dropdown-item.redes { color: var(--accent); }

        .balance-badge {
            background: linear-gradient(135deg, var(--success), var(--accent));
            color: var(--dark);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        .hero {
            position: relative;
            z-index: 5;
            text-align: center;
            padding: 4rem 5% 2rem;
        }

        .hero h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 4rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p { font-size: 1.1rem; opacity: 0.9; margin-bottom: 1.5rem; }

        .hero-features {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .hero-feature {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem 2rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hero-feature span { font-size: 2rem; display: block; margin-bottom: 0.5rem; }

        .cta-button {
            display: inline-block;
            padding: 1rem 3rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--dark);
            font-weight: 600;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .section {
            position: relative;
            z-index: 5;
            padding: 2rem 5%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .rifas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 1.5rem;
        }

        .rifa-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .rifa-card:hover {
            transform: translateY(-10px);
            border-color: var(--primary);
            box-shadow: 0 20px 60px rgba(255, 107, 53, 0.3);
        }

        .rifa-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
        }

        .rifa-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .rifa-badge {
            position: absolute;
            top: 10px; right: 10px;
            background: var(--success);
            color: var(--dark);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .rifa-timer {
            position: absolute;
            bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.8);
            color: var(--secondary);
            padding: 0.3rem 0.8rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .rifa-content { padding: 1.5rem; }

        .rifa-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--secondary);
            margin-bottom: 0.3rem;
        }

        .rifa-description {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 1rem;
        }

        .rifa-tipo-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
        }

        .tipo-dinero { background: rgba(6, 255, 165, 0.2); color: var(--success); }
        .tipo-objeto { background: rgba(0, 180, 216, 0.2); color: var(--accent); }
        .tipo-otro { background: rgba(155, 93, 229, 0.2); color: var(--purple); }

        .rifa-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .stat { text-align: center; }
        .stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; color: var(--success); }
        .stat-label { font-size: 0.7rem; opacity: 0.7; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }

        .btn-participar {
            width: 100%;
            padding: 0.9rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--dark);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-participar:disabled { opacity: 0.5; cursor: not-allowed; }

        .ganadores-list { display: grid; gap: 1rem; }

        .ganador-item {
            background: rgba(6, 255, 165, 0.1);
            border: 1px solid var(--success);
            border-radius: 15px;
            padding: 1.2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .ganador-icon { font-size: 2.5rem; }
        .ganador-info { flex: 1; }
        .ganador-nombre { font-weight: 600; font-size: 1.1rem; }
        .ganador-premio { opacity: 0.8; font-size: 0.9rem; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--dark);
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-content.wide { max-width: 800px; }

        .modal-close {
            position: absolute;
            top: 1rem; right: 1rem;
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.8rem;
            cursor: pointer;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--secondary);
            text-align: center;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.9rem; }
        .form-group label .required { color: var(--danger); }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: var(--light);
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
        }

        .form-group input:focus,
        .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-group input::placeholder { color: rgba(255, 255, 255, 0.4); }

        .phone-input { display: flex; gap: 0.5rem; }
        .phone-input select { width: 120px; flex-shrink: 0; }
        .phone-input input { flex: 1; }

        .form-hint { font-size: 0.75rem; opacity: 0.6; margin-top: 0.3rem; }

        .btn-submit {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--success), var(--accent));
            color: var(--dark);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }

        .form-link { text-align: center; margin-top: 1rem; font-size: 0.9rem; }
        .form-link a { color: var(--accent); cursor: pointer; text-decoration: underline; }

        .referido-section {
            background: rgba(155, 93, 229, 0.1);
            border: 1px solid var(--purple);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.2rem;
        }

        .referido-section label { color: var(--purple); }

        /* Payment Box */
        .payment-box {
            background: linear-gradient(135deg, rgba(255, 210, 63, 0.1), rgba(255, 107, 53, 0.1));
            border: 2px solid var(--secondary);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin: 1rem 0;
        }

        .payment-box h4 { color: var(--secondary); margin-bottom: 1rem; font-size: 1.1rem; }

        .payment-info {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .payment-info p { margin: 0.5rem 0; font-size: 0.9rem; }
        .payment-info strong { color: var(--secondary); }

        .payment-email {
            font-family: monospace;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: inline-block;
            margin: 0.5rem 0;
            cursor: pointer;
        }

        .file-upload {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }

        .file-upload:hover { border-color: var(--primary); background: rgba(255,107,53,0.1); }
        .file-upload.has-file { border-color: var(--success); background: rgba(6,255,165,0.1); }
        .file-upload input { display: none; }

        /* Profile Stats */
        .profile-header { text-align: center; margin-bottom: 2rem; }

        .profile-avatar {
            width: 100px; height: 100px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--dark);
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .profile-avatar .edit-overlay {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.3rem;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-avatar:hover .edit-overlay { opacity: 1; }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .profile-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .profile-stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--success); }
        .profile-stat-label { font-size: 0.8rem; opacity: 0.7; }

        .referral-box {
            background: linear-gradient(135deg, rgba(155, 93, 229, 0.2), rgba(0, 180, 216, 0.2));
            border: 1px solid var(--purple);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .referral-box h4 { color: var(--purple); margin-bottom: 0.5rem; }

        .referral-code {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 5px;
            color: var(--secondary);
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem 1.5rem;
            border-radius: 10px;
            display: inline-block;
            cursor: pointer;
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .referral-stat { text-align: center; }
        .referral-stat-value { font-weight: 700; color: var(--success); font-size: 1.2rem; }
        .referral-stat-label { font-size: 0.7rem; opacity: 0.7; }

        /* Admin Panel */
        .admin-panel {
            display: none;
            position: relative;
            z-index: 5;
            padding: 2rem 5%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .admin-panel.active { display: block; }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 0.8rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .admin-tab.active { background: var(--primary); border-color: var(--primary); }
        .admin-tab:hover { background: rgba(255, 107, 53, 0.3); }

        .admin-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.2rem;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--success); }
        .stat-card-label { opacity: 0.8; font-size: 0.8rem; }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .admin-table th,
        .admin-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }

        .admin-table th { background: rgba(0, 0, 0, 0.3); font-weight: 600; }
        .admin-table tr:hover { background: rgba(255, 255, 255, 0.02); }

        .btn-small {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.75rem;
            margin: 0.1rem;
        }

        .btn-edit { background: var(--accent); color: var(--dark); }
        .btn-toggle { background: var(--secondary); color: var(--dark); }
        .btn-delete { background: var(--danger); color: var(--light); }
        .btn-approve { background: var(--success); color: var(--dark); }
        .btn-reject { background: var(--danger); color: var(--light); }
        .btn-view { background: var(--purple); color: var(--light); }

        .btn-nuevo {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, var(--success), var(--accent));
            color: var(--dark);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-active { background: rgba(6, 255, 165, 0.2); color: var(--success); }
        .status-inactive { background: rgba(255, 82, 82, 0.2); color: var(--danger); }
        .status-pending { background: rgba(255, 167, 38, 0.2); color: var(--warning); }
        .status-approved { background: rgba(6, 255, 165, 0.2); color: var(--success); }
        .status-rejected { background: rgba(255, 82, 82, 0.2); color: var(--danger); }

        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0; }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255,255,255,0.2);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle.active { background: var(--success); }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px; left: 3px;
            width: 20px; height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle.active::after { transform: translateX(24px); }

        /* Boletos Selector */
        .boletos-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .btn-cantidad {
            width: 45px; height: 45px;
            background: var(--primary);
            color: var(--light);
            border: none;
            border-radius: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cantidad-display {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            min-width: 60px;
            text-align: center;
        }

        /* Redes Sociales */
        .redes-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .red-social {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            text-decoration: none;
            color: var(--light);
            transition: all 0.3s ease;
        }

        .red-social:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
        .red-social-icon { font-size: 2rem; }
        .red-social-info h4 { color: var(--secondary); }
        .red-social-info p { font-size: 0.85rem; opacity: 0.7; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            opacity: 0.7;
        }

        .empty-state span { font-size: 3rem; display: block; margin-bottom: 1rem; }

        /* Comprobante Preview */
        .comprobante-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin: 1rem auto;
            display: block;
        }

        /* Footer */
        footer {
            position: relative;
            z-index: 5;
            text-align: center;
            padding: 2rem 5%;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 3rem;
        }

        .loading { display: flex; align-items: center; justify-content: center; padding: 3rem; }

        .spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 20px; right: 20px;
            background: var(--dark);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Tabs inside modal */
        .modal-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.5rem;
        }

        .modal-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: var(--light);
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .modal-tab.active { opacity: 1; border-bottom: 2px solid var(--primary); }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 1rem; }
            nav { flex-wrap: wrap; justify-content: center; }
            .hero h1 { font-size: 2.5rem; }
            .form-row { grid-template-columns: 1fr; }
            .rifas-grid { grid-template-columns: 1fr; }
        }

        .auth-buttons.hidden { display: none; }
    </style>
</head>
<body>
    <div class="background-dots" id="dots"></div>

    <header>
        <div class="logo" onclick="irInicio()">RIFAMAX</div>
        <nav>
            <a href="#rifas">Rifas</a>
            <a href="#ganadores">Ganadores</a>
            <a href="#como-funciona">¬øC√≥mo funciona?</a>
            
            <div class="nav-buttons auth-buttons" id="authButtons">
                <button class="btn-login" onclick="abrirModal('modalLogin')">Iniciar Sesi√≥n</button>
                <button class="btn-register" onclick="abrirModal('modalRegistro')">Registrarse</button>
            </div>

            <div class="user-menu" id="userMenu">
                <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">
                    <span id="avatarContent">üë§</span>
                </div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-header">
                        <div class="dropdown-avatar" id="dropdownAvatar">
                            <span id="dropdownAvatarContent">üë§</span>
                        </div>
                        <div class="dropdown-info">
                            <h4 id="dropdownUserName">Usuario</h4>
                            <p id="dropdownUserEmail">email@ejemplo.com</p>
                        </div>
                    </div>
                    <div class="dropdown-item" onclick="abrirModal('modalPerfil')">
                        <span>üë§</span> Mi Perfil
                    </div>
                    <div class="dropdown-item" onclick="abrirModal('modalEstadisticas')">
                        <span>üìä</span> Mis Estad√≠sticas
                    </div>
                    <div class="dropdown-item" onclick="abrirModal('modalMisBoletos')">
                        <span>üéüÔ∏è</span> Mis Boletos
                    </div>
                    <div class="dropdown-item" onclick="abrirModal('modalMisPremios')">
                        <span>üèÜ</span> Mis Premios
                    </div>
                    <div class="dropdown-item" onclick="abrirModal('modalReferidos')">
                        <span>ü§ù</span> Mis Referidos
                        <span class="balance-badge" id="balanceReferidos">$0.00</span>
                    </div>
                    <div class="dropdown-item redes" onclick="abrirModal('modalRedes')">
                        <span>üåê</span> Redes Sociales
                    </div>
                    <div class="dropdown-item admin" id="adminMenuItem" style="display: none;" onclick="mostrarPanelAdmin()">
                        <span>‚öôÔ∏è</span> Panel Admin
                    </div>
                    <div class="dropdown-item logout" onclick="cerrarSesion()">
                        <span>üö™</span> Cerrar Sesi√≥n
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main id="mainContent">
        <section class="hero">
            <h1>¬°TU SUERTE EMPIEZA AQU√ç!</h1>
            <p>Participa en las rifas m√°s emocionantes y gana premios incre√≠bles</p>
            <div class="hero-features">
                <div class="hero-feature"><span>üéüÔ∏è</span><strong>$1 USD</strong><small>por boleto</small></div>
                <div class="hero-feature"><span>üí∞</span><strong>$100 USD</strong><small>premio</small></div>
                <div class="hero-feature"><span>ü§ù</span><strong>$0.10</strong><small>por referido</small></div>
            </div>
            <button class="cta-button" onclick="abrirModal('modalRegistro')">¬°Participa Ahora!</button>
        </section>

        <section class="section" id="rifas">
            <h2 class="section-title">üé∞ Rifas Activas</h2>
            <div class="rifas-grid" id="rifasGrid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </section>

        <section class="section" id="ganadores">
            <h2 class="section-title">üèÜ Ganadores Recientes</h2>
            <div class="ganadores-list" id="ganadoresList">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </section>

        <section class="section" id="como-funciona">
            <h2 class="section-title">üìñ ¬øC√≥mo Funciona?</h2>
            <div class="rifas-grid">
                <div class="rifa-card">
                    <div class="rifa-content" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">1Ô∏è‚É£</div>
                        <h3 style="color: var(--secondary);">Reg√≠strate</h3>
                        <p style="opacity: 0.8;">Crea tu cuenta gratis y obt√©n tu c√≥digo de referido √∫nico.</p>
                    </div>
                </div>
                <div class="rifa-card">
                    <div class="rifa-content" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">2Ô∏è‚É£</div>
                        <h3 style="color: var(--secondary);">Compra Boletos</h3>
                        <p style="opacity: 0.8;">Transfiere a Binance y adjunta tu comprobante.</p>
                    </div>
                </div>
                <div class="rifa-card">
                    <div class="rifa-content" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">3Ô∏è‚É£</div>
                        <h3 style="color: var(--secondary);">¬°Gana!</h3>
                        <p style="opacity: 0.8;">Espera el sorteo y gana hasta $100 USD. ¬°As√≠ de f√°cil!</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Admin Panel -->
    <section class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <h2 class="section-title" style="margin: 0;">‚öôÔ∏è Panel de Administraci√≥n</h2>
            <button class="btn-login" onclick="cerrarPanelAdmin()">‚Üê Volver</button>
        </div>
        <div class="admin-tabs">
            <div class="admin-tab active" onclick="cambiarTabAdmin('dashboard', this)">Dashboard</div>
            <div class="admin-tab" onclick="cambiarTabAdmin('rifas', this)">Rifas</div>
            <div class="admin-tab" onclick="cambiarTabAdmin('usuarios', this)">Usuarios</div>
            <div class="admin-tab" onclick="cambiarTabAdmin('compras', this)">Compras</div>
            <div class="admin-tab" onclick="cambiarTabAdmin('pagos', this)">üì• Pagos Pendientes</div>
        </div>
        <div class="admin-content">
            <div id="tabDashboard" class="admin-tab-content">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-card-value" id="adminTotalUsuarios">0</div><div class="stat-card-label">Usuarios</div></div>
                    <div class="stat-card"><div class="stat-card-value" id="adminTotalRifas">0</div><div class="stat-card-label">Rifas Activas</div></div>
                    <div class="stat-card"><div class="stat-card-value" id="adminTotalBoletos">0</div><div class="stat-card-label">Boletos Vendidos</div></div>
                    <div class="stat-card"><div class="stat-card-value" id="adminTotalIngresos">$0</div><div class="stat-card-label">Ingresos</div></div>
                    <div class="stat-card"><div class="stat-card-value" id="adminTotalComisiones">$0</div><div class="stat-card-label">Comisiones</div></div>
                    <div class="stat-card"><div class="stat-card-value" id="adminPagosPendientes">0</div><div class="stat-card-label">Pagos Pendientes</div></div>
                </div>
            </div>
            <div id="tabRifas" class="admin-tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h3>Gesti√≥n de Rifas</h3>
                    <button class="btn-nuevo" onclick="abrirModalNuevaRifa()">+ Nueva Rifa</button>
                </div>
                <div style="overflow-x: auto;"><table class="admin-table"><thead><tr><th>Rifa</th><th>Tipo</th><th>Premio</th><th>Boletos</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="rifasAdminBody"></tbody></table></div>
            </div>
            <div id="tabUsuarios" class="admin-tab-content" style="display: none;">
                <h3 style="margin-bottom: 1rem;">Usuarios</h3>
                <div style="overflow-x: auto;"><table class="admin-table"><thead><tr><th>Usuario</th><th>Email</th><th>Tel√©fono</th><th>Balance Email</th><th>Referidos</th><th>Acciones</th></tr></thead><tbody id="usuariosAdminBody"></tbody></table></div>
            </div>
            <div id="tabCompras" class="admin-tab-content" style="display: none;">
                <h3 style="margin-bottom: 1rem;">Compras Aprobadas</h3>
                <div style="overflow-x: auto;"><table class="admin-table"><thead><tr><th>Usuario</th><th>Rifa</th><th>Boletos</th><th>Total</th><th>Estado</th><th>Fecha</th></tr></thead><tbody id="comprasAdminBody"></tbody></table></div>
            </div>
            <div id="tabPagos" class="admin-tab-content" style="display: none;">
                <h3 style="margin-bottom: 1rem;">üì• Pagos Pendientes de Aprobaci√≥n</h3>
                <div style="overflow-x: auto;"><table class="admin-table"><thead><tr><th>Usuario</th><th>Rifa</th><th>Boletos</th><th>Total</th><th>Comprobante</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody id="pagosAdminBody"></tbody></table></div>
            </div>
        </div>
    </section>

    <!-- MODALES -->
    
    <!-- Login -->
    <div class="modal" id="modalLogin">
        <div class="modal-content" style="max-width: 400px;">
            <button class="modal-close" onclick="cerrarModal('modalLogin')">√ó</button>
            <h3 class="modal-title">üîê Iniciar Sesi√≥n</h3>
            <form onsubmit="iniciarSesion(event)">
                <div class="form-group"><label>Correo <span class="required">*</span></label><input type="email" id="loginEmail" required placeholder="tu@email.com"></div>
                <div class="form-group"><label>Contrase√±a <span class="required">*</span></label><input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button type="submit" class="btn-submit" id="btnLogin">Iniciar Sesi√≥n</button>
            </form>
            <div class="form-link">¬øNo tienes cuenta? <a onclick="cambiarModal('modalLogin', 'modalRegistro')">Reg√≠strate</a></div>
        </div>
    </div>

    <!-- Registro -->
    <div class="modal" id="modalRegistro">
        <div class="modal-content">
            <button class="modal-close" onclick="cerrarModal('modalRegistro')">√ó</button>
            <h3 class="modal-title">üìù Crear Cuenta</h3>
            <form onsubmit="registrarUsuario(event)">
                <div class="form-row">
                    <div class="form-group"><label>Nombre <span class="required">*</span></label><input type="text" id="regNombre" required></div>
                    <div class="form-group"><label>Apellido <span class="required">*</span></label><input type="text" id="regApellido" required></div>
                </div>
                <div class="form-group"><label>Correo <span class="required">*</span></label><input type="email" id="regEmail" required></div>
                <div class="form-group"><label>Confirmar Correo <span class="required">*</span></label><input type="email" id="regEmailConfirm" required></div>
                <div class="form-group">
                    <label>Tel√©fono <span class="required">*</span></label>
                    <div class="phone-input">
                        <select id="regCodigoPais">
                            <option value="+1">üá∫üá∏ +1</option><option value="+52">üá≤üáΩ +52</option><option value="+54">üá¶üá∑ +54</option>
                            <option value="+55">üáßüá∑ +55</option><option value="+56">üá®üá± +56</option><option value="+57">üá®üá¥ +57</option>
                            <option value="+58">üáªüá™ +58</option><option value="+34">üá™üá∏ +34</option><option value="+51">üáµüá™ +51</option>
                        </select>
                        <input type="tel" id="regTelefono" required placeholder="N√∫mero">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Contrase√±a <span class="required">*</span></label><input type="password" id="regPassword" required minlength="6"></div>
                    <div class="form-group"><label>Confirmar <span class="required">*</span></label><input type="password" id="regPasswordConfirm" required></div>
                </div>
                <div class="referido-section">
                    <div class="form-group" style="margin: 0;">
                        <label>üéÅ C√≥digo de Referido (opcional)</label>
                        <input type="text" id="regCodigoReferido" maxlength="6" style="text-transform: uppercase;">
                    </div>
                </div>
                <button type="submit" class="btn-submit" id="btnRegistro">Crear Cuenta</button>
            </form>
            <div class="form-link">¬øYa tienes cuenta? <a onclick="cambiarModal('modalRegistro', 'modalLogin')">Inicia sesi√≥n</a></div>
        </div>
    </div>

    <!-- Perfil -->
    <div class="modal" id="modalPerfil">
        <div class="modal-content" style="max-width: 450px;">
            <button class="modal-close" onclick="cerrarModal('modalPerfil')">√ó</button>
            <h3 class="modal-title">üë§ Mi Perfil</h3>
            <div class="profile-header">
                <div class="profile-avatar" onclick="document.getElementById('avatarInput').click()">
                    <span id="profileAvatarContent">üë§</span>
                    <div class="edit-overlay">üì∑ Cambiar</div>
                </div>
                <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="cambiarAvatar(event)">
                <h3 id="profileNombreCompleto">Usuario</h3>
                <p style="opacity: 0.7;" id="profileEmail">email@ejemplo.com</p>
            </div>
            <form onsubmit="actualizarPerfil(event)">
                <div class="form-row">
                    <div class="form-group"><label>Nombre</label><input type="text" id="editNombre"></div>
                    <div class="form-group"><label>Apellido</label><input type="text" id="editApellido"></div>
                </div>
                <div class="form-group"><label>Tel√©fono</label><input type="tel" id="editTelefono" readonly style="opacity: 0.6;"></div>
                <div class="form-group">
                    <label>üìß Correo de Balance (para reembolsos)</label>
                    <input type="email" id="editBalanceEmail" placeholder="correo@binance.com">
                    <p class="form-hint">Este correo se usar√° para reembolsos v√≠a Binance</p>
                </div>
                <button type="submit" class="btn-submit">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="modal" id="modalEstadisticas">
        <div class="modal-content" style="max-width: 450px;">
            <button class="modal-close" onclick="cerrarModal('modalEstadisticas')">√ó</button>
            <h3 class="modal-title">üìä Mis Estad√≠sticas</h3>
            <div class="profile-stats">
                <div class="profile-stat"><div class="profile-stat-value" id="statBoletosComprados">0</div><div class="profile-stat-label">Boletos</div></div>
                <div class="profile-stat"><div class="profile-stat-value" id="statDineroGastado">$0</div><div class="profile-stat-label">Gastado</div></div>
                <div class="profile-stat"><div class="profile-stat-value" id="statRifasParticipadas">0</div><div class="profile-stat-label">Rifas</div></div>
                <div class="profile-stat"><div class="profile-stat-value" id="statPremiosGanados">0</div><div class="profile-stat-label">Premios</div></div>
            </div>
        </div>
    </div>

    <!-- Mis Boletos -->
    <div class="modal" id="modalMisBoletos">
        <div class="modal-content">
            <button class="modal-close" onclick="cerrarModal('modalMisBoletos')">√ó</button>
            <h3 class="modal-title">üéüÔ∏è Mis Boletos</h3>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="cambiarTabBoletos('aprobados', this)">Aprobados</button>
                <button class="modal-tab" onclick="cambiarTabBoletos('pendientes', this)">Pendientes</button>
            </div>
            <div id="listaMisBoletosAprobados"></div>
            <div id="listaMisBoletospendientes" style="display: none;"></div>
        </div>
    </div>

    <!-- Mis Premios -->
    <div class="modal" id="modalMisPremios">
        <div class="modal-content">
            <button class="modal-close" onclick="cerrarModal('modalMisPremios')">√ó</button>
            <h3 class="modal-title">üèÜ Mis Premios Ganados</h3>
            <div id="listaMisPremios"></div>
        </div>
    </div>

    <!-- Referidos -->
    <div class="modal" id="modalReferidos">
        <div class="modal-content" style="max-width: 450px;">
            <button class="modal-close" onclick="cerrarModal('modalReferidos')">√ó</button>
            <h3 class="modal-title">ü§ù Mis Referidos</h3>
            <div class="referral-box">
                <h4>Tu C√≥digo de Referido</h4>
                <div class="referral-code" id="miCodigoReferido" onclick="copiarCodigoReferido()">------</div>
                <p style="font-size: 0.8rem; opacity: 0.7;">Click para copiar</p>
                <div class="referral-stats">
                    <div class="referral-stat"><div class="referral-stat-value" id="totalReferidos">0</div><div class="referral-stat-label">Referidos</div></div>
                    <div class="referral-stat"><div class="referral-stat-value" id="boletosReferidos">0</div><div class="referral-stat-label">Sus Boletos</div></div>
                    <div class="referral-stat"><div class="referral-stat-value" id="dineroReferidos">$0.00</div><div class="referral-stat-label">Ganado</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Redes Sociales -->
    <div class="modal" id="modalRedes">
        <div class="modal-content" style="max-width: 450px;">
            <button class="modal-close" onclick="cerrarModal('modalRedes')">√ó</button>
            <h3 class="modal-title">üåê Redes Sociales</h3>
            <p style="text-align: center; margin-bottom: 1.5rem; opacity: 0.8;">S√≠guenos para verificar la autenticidad del proyecto</p>
            <div class="redes-container">
                <a href="https://www.instagram.com/mal_ave_/" target="_blank" class="red-social">
                    <div class="red-social-icon">üì∏</div>
                    <div class="red-social-info">
                        <h4>Instagram</h4>
                        <p>@mal_ave_</p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Participar / Comprar -->
    <div class="modal" id="modalParticipar">
        <div class="modal-content" style="max-width: 450px;">
            <button class="modal-close" onclick="cerrarModal('modalParticipar')">√ó</button>
            <h3 class="modal-title" id="modalParticiparTitle">üéüÔ∏è Comprar Boletos</h3>
            
            <div id="pasoSeleccion">
                <div style="text-align: center; margin-bottom: 1rem;"><p>Precio: <strong style="color: var(--success);" id="precioBoletoPaso1">$1 USD</strong></p></div>
                <div class="boletos-selector">
                    <button type="button" class="btn-cantidad" onclick="cambiarCantidadBoletos(-1)">‚àí</button>
                    <div class="cantidad-display" id="cantidadBoletosDisplay">1</div>
                    <button type="button" class="btn-cantidad" onclick="cambiarCantidadBoletos(1)">+</button>
                </div>
                <div style="text-align: center; margin: 1rem 0;">
                    <p>Total a pagar:</p>
                    <p style="font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; color: var(--secondary);" id="totalPagarBoletos">$1.00</p>
                </div>
                <button class="btn-submit" onclick="irPasoPago()">Continuar al Pago ‚Üí</button>
            </div>

            <div id="pasoPago" style="display: none;">
                <div class="payment-box">
                    <h4>üí≥ Datos de Pago - Binance</h4>
                    <div class="payment-info">
                        <p>Env√≠a el monto exacto a:</p>
                        <div class="payment-email" onclick="copiarEmailPago()">Fabricio9061@gmail.com</div>
                        <p style="font-size: 0.8rem; opacity: 0.7;">Click para copiar</p>
                        <p style="margin-top: 1rem;"><strong>Monto:</strong> <span id="montoPagar" style="color: var(--success); font-size: 1.2rem;">$1.00 USD</span></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üìé Adjuntar Comprobante de Pago <span class="required">*</span></label>
                    <div class="file-upload" id="fileUploadZone" onclick="document.getElementById('comprobanteInput').click()">
                        <span>üìÑ</span>
                        <p id="fileUploadText">Click para subir imagen o PDF</p>
                    </div>
                    <input type="file" id="comprobanteInput" accept="image/*,.pdf" style="display: none;" onchange="previewComprobante(event)">
                    <img id="comprobantePreview" class="comprobante-preview" style="display: none;">
                </div>

                <button class="btn-submit" onclick="enviarComprobante()" id="btnEnviarComprobante">Enviar Comprobante</button>
                <button class="btn-submit" style="background: transparent; border: 1px solid var(--accent); color: var(--accent); margin-top: 0.5rem;" onclick="volverPasoSeleccion()">‚Üê Volver</button>
            </div>
        </div>
    </div>

    <!-- Nueva/Editar Rifa Admin -->
    <div class="modal" id="modalNuevaRifa">
        <div class="modal-content wide">
            <button class="modal-close" onclick="cerrarModal('modalNuevaRifa')">√ó</button>
            <h3 class="modal-title" id="modalRifaTitle">‚ûï Nueva Rifa</h3>
            <form onsubmit="guardarRifa(event)">
                <div class="form-row">
                    <div class="form-group"><label>T√≠tulo <span class="required">*</span></label><input type="text" id="rifaTitulo" required></div>
                    <div class="form-group">
                        <label>Tipo de Premio</label>
                        <select id="rifaTipoPremio">
                            <option value="dinero">üíµ Dinero</option>
                            <option value="objeto">üéÅ Objeto</option>
                            <option value="otro">‚ú® Otro</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="rifaDescripcion" rows="2"></textarea></div>
                <div class="form-row">
                    <div class="form-group"><label>√çcono (emoji)</label><input type="text" id="rifaIcono" value="üéÅ"></div>
                    <div class="form-group"><label>Premio (USD o descripci√≥n)</label><input type="text" id="rifaPremio" value="100"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Precio Boleto (USD)</label><input type="number" id="rifaPrecioBoleto" value="1" min="0.1" step="0.1"></div>
                    <div class="form-group"><label>Total Boletos</label><input type="number" id="rifaTotalBoletos" value="100" min="10"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>D√≠as de Duraci√≥n</label><input type="number" id="rifaDias" value="7" min="1"></div>
                    <div class="form-group">
                        <label>Imagen/Flyer</label>
                        <input type="file" id="rifaImagen" accept="image/*">
                    </div>
                </div>
                <div class="form-group">
                    <label>Comisiones por Referido</label>
                    <div class="toggle-container">
                        <div class="toggle" id="toggleComisiones" onclick="toggleComisiones()"></div>
                        <span>Activar comisiones</span>
                    </div>
                    <div id="comisionesConfig" style="display: none; margin-top: 0.5rem;">
                        <div class="form-row">
                            <div class="form-group"><label>Porcentaje (%)</label><input type="number" id="rifaComisionPorcentaje" value="10" min="1" max="50"></div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-submit">Guardar Rifa</button>
            </form>
        </div>
    </div>

    <!-- Ver Usuario Admin -->
    <div class="modal" id="modalVerUsuario">
        <div class="modal-content wide">
            <button class="modal-close" onclick="cerrarModal('modalVerUsuario')">√ó</button>
            <h3 class="modal-title">üë§ Detalles del Usuario</h3>
            <div id="detalleUsuarioContent"></div>
        </div>
    </div>

    <!-- Ver Comprobante -->
    <div class="modal" id="modalVerComprobante">
        <div class="modal-content">
            <button class="modal-close" onclick="cerrarModal('modalVerComprobante')">√ó</button>
            <h3 class="modal-title">üìé Comprobante de Pago</h3>
            <img id="comprobanteViewer" style="max-width: 100%; border-radius: 10px;">
        </div>
    </div>

    <footer>
        <p>&copy; 2025 RifaMax. Todos los derechos reservados.</p>
        <p style="opacity: 0.7; margin-top: 0.5rem;">Juega responsablemente. Mayores de 18 a√±os.</p>
    </footer>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBrr8F9G93klUb-8Kk7fgmJ7t1D6ObRXic",
            authDomain: "rifamax.firebaseapp.com",
            projectId: "rifamax",
            storageBucket: "rifamax.firebasestorage.app",
            messagingSenderId: "916004942628",
            appId: "1:916004942628:web:02a27ba494358860f739b1"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        const ADMIN_EMAIL = 'fabricio9061@gmail.com';
        const BINANCE_EMAIL = 'Fabricio9061@gmail.com';

        let currentUser = null;
        let userData = null;
        let rifas = [];
        let rifaSeleccionada = null;
        let cantidadBoletos = 1;
        let rifaEditando = null;
        let comprobanteFile = null;
        let comisionesActivas = false;

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            crearFondo();
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    await cargarDatosUsuario();
                    actualizarUIUsuario();
                } else {
                    userData = null;
                    actualizarUIUsuario();
                }
            });
            cargarRifas();
            cargarGanadores();
            
            // Actualizar temporizadores cada segundo
            setInterval(actualizarTemporizadores, 1000);
            
            document.addEventListener('click', (e) => {
                const userMenu = document.getElementById('userMenu');
                if (userMenu && !userMenu.contains(e.target)) {
                    document.getElementById('userDropdown').classList.remove('show');
                }
            });
        });

        function crearFondo() {
            const container = document.getElementById('dots');
            for (let i = 0; i < 50; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.style.left = Math.random() * 100 + '%';
                dot.style.top = Math.random() * 100 + '%';
                dot.style.animationDelay = Math.random() * 20 + 's';
                container.appendChild(dot);
            }
        }

        // Auth
        async function registrarUsuario(e) {
            e.preventDefault();
            const nombre = document.getElementById('regNombre').value.trim();
            const apellido = document.getElementById('regApellido').value.trim();
            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const emailConfirm = document.getElementById('regEmailConfirm').value.trim().toLowerCase();
            const codigoPais = document.getElementById('regCodigoPais').value;
            const telefono = document.getElementById('regTelefono').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const codigoReferido = document.getElementById('regCodigoReferido').value.trim().toUpperCase();

            if (email !== emailConfirm) { mostrarToast('Los correos no coinciden', 'error'); return; }
            if (password !== passwordConfirm) { mostrarToast('Las contrase√±as no coinciden', 'error'); return; }

            const btn = document.getElementById('btnRegistro');
            btn.disabled = true; btn.textContent = 'Creando...';

            try {
                let referidorId = null;
                if (codigoReferido) {
                    const refQuery = await db.collection('usuarios').where('codigoReferido', '==', codigoReferido).get();
                    if (refQuery.empty) { mostrarToast('C√≥digo de referido inv√°lido', 'error'); btn.disabled = false; btn.textContent = 'Crear Cuenta'; return; }
                    referidorId = refQuery.docs[0].id;
                }

                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const miCodigoReferido = generarCodigoReferido();

                await db.collection('usuarios').doc(userCredential.user.uid).set({
                    nombre, apellido, email,
                    telefono: codigoPais + telefono,
                    codigoReferido: miCodigoReferido,
                    referidoPor: referidorId,
                    avatarUrl: null,
                    balanceEmail: null,
                    totalReferidos: 0,
                    fechaRegistro: firebase.firestore.FieldValue.serverTimestamp(),
                    esAdmin: email === ADMIN_EMAIL
                });

                if (referidorId) {
                    await db.collection('usuarios').doc(referidorId).update({
                        totalReferidos: firebase.firestore.FieldValue.increment(1)
                    });
                }

                cerrarModal('modalRegistro');
                mostrarToast('¬°Cuenta creada!', 'success');
            } catch (error) {
                mostrarToast(error.code === 'auth/email-already-in-use' ? 'Correo ya registrado' : 'Error al crear cuenta', 'error');
            }
            btn.disabled = false; btn.textContent = 'Crear Cuenta';
        }

        async function iniciarSesion(e) {
            e.preventDefault();
            const btn = document.getElementById('btnLogin');
            btn.disabled = true; btn.textContent = 'Entrando...';
            try {
                await auth.signInWithEmailAndPassword(
                    document.getElementById('loginEmail').value.trim(),
                    document.getElementById('loginPassword').value
                );
                cerrarModal('modalLogin');
                mostrarToast('¬°Bienvenido!', 'success');
            } catch { mostrarToast('Credenciales incorrectas', 'error'); }
            btn.disabled = false; btn.textContent = 'Iniciar Sesi√≥n';
        }

        async function cerrarSesion() {
            await auth.signOut();
            cerrarPanelAdmin();
            document.getElementById('userDropdown').classList.remove('show');
        }

        async function cargarDatosUsuario() {
            if (!currentUser) return;
            const doc = await db.collection('usuarios').doc(currentUser.uid).get();
            if (doc.exists) userData = { id: doc.id, ...doc.data() };
        }

        function actualizarUIUsuario() {
            const authButtons = document.getElementById('authButtons');
            const userMenu = document.getElementById('userMenu');
            
            if (currentUser && userData) {
                authButtons.classList.add('hidden');
                userMenu.classList.add('active');
                const inicial = userData.nombre ? userData.nombre.charAt(0).toUpperCase() : 'üë§';
                const avatarHTML = userData.avatarUrl ? `<img src="${userData.avatarUrl}">` : inicial;
                document.getElementById('avatarContent').innerHTML = avatarHTML;
                document.getElementById('dropdownAvatarContent').innerHTML = avatarHTML;
                document.getElementById('dropdownUserName').textContent = `${userData.nombre} ${userData.apellido}`;
                document.getElementById('dropdownUserEmail').textContent = userData.email;
                document.getElementById('adminMenuItem').style.display = (userData.esAdmin || userData.email === ADMIN_EMAIL) ? 'flex' : 'none';
                actualizarBalanceReferidos();
            } else {
                authButtons.classList.remove('hidden');
                userMenu.classList.remove('active');
            }
        }

        async function actualizarBalanceReferidos() {
            if (!currentUser) return;
            try {
                const comprasQuery = await db.collection('compras').where('referidorId', '==', currentUser.uid).where('estado', '==', 'aprobado').get();
                let total = 0;
                comprasQuery.forEach(doc => {
                    const d = doc.data();
                    total += (d.cantidad || 0) * (d.comisionPorBoleto || 0.10);
                });
                document.getElementById('balanceReferidos').textContent = `$${total.toFixed(2)}`;
            } catch {}
        }

        function generarCodigoReferido() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let codigo = '';
            for (let i = 0; i < 6; i++) codigo += chars.charAt(Math.floor(Math.random() * chars.length));
            return codigo;
        }

        function copiarCodigoReferido() {
            navigator.clipboard.writeText(document.getElementById('miCodigoReferido').textContent);
            mostrarToast('¬°C√≥digo copiado!', 'success');
        }

        function copiarEmailPago() {
            navigator.clipboard.writeText(BINANCE_EMAIL);
            mostrarToast('¬°Email copiado!', 'success');
        }

        // Rifas
        async function cargarRifas() {
            try {
                const snapshot = await db.collection('rifas').where('activa', '==', true).get();
                rifas = [];
                snapshot.forEach(doc => rifas.push({ id: doc.id, ...doc.data() }));
                renderizarRifas();
            } catch { document.getElementById('rifasGrid').innerHTML = '<p style="text-align: center;">Error al cargar</p>'; }
        }

        function renderizarRifas() {
            const grid = document.getElementById('rifasGrid');
            if (rifas.length === 0) { grid.innerHTML = '<div class="empty-state"><span>üé∞</span><p>No hay rifas activas</p></div>'; return; }
            
            grid.innerHTML = rifas.map(r => {
                const progreso = ((r.boletosVendidos || 0) / r.totalBoletos) * 100;
                const disponibles = r.totalBoletos - (r.boletosVendidos || 0);
                const tipoClass = r.tipoPremio === 'dinero' ? 'tipo-dinero' : r.tipoPremio === 'objeto' ? 'tipo-objeto' : 'tipo-otro';
                const tipoText = r.tipoPremio === 'dinero' ? 'üíµ Dinero' : r.tipoPremio === 'objeto' ? 'üéÅ Objeto' : '‚ú® Premio';
                
                return `
                    <div class="rifa-card">
                        <div class="rifa-image">
                            ${r.imagenUrl ? `<img src="${r.imagenUrl}">` : (r.icono || 'üéÅ')}
                            <span class="rifa-badge">üî• Activa</span>
                            <div class="rifa-timer" data-fecha="${r.fechaFin || ''}" data-id="${r.id}">‚è±Ô∏è Cargando...</div>
                        </div>
                        <div class="rifa-content">
                            <span class="rifa-tipo-badge ${tipoClass}">${tipoText}</span>
                            <h3 class="rifa-title">${r.titulo}</h3>
                            <p class="rifa-description">${r.descripcion || ''}</p>
                            <div class="rifa-stats">
                                <div class="stat"><div class="stat-value">$${r.precioBoleto || 1}</div><div class="stat-label">Boleto</div></div>
                                <div class="stat"><div class="stat-value">${r.tipoPremio === 'dinero' ? '$' : ''}${r.premio}</div><div class="stat-label">Premio</div></div>
                                <div class="stat"><div class="stat-value">${disponibles}</div><div class="stat-label">Disponibles</div></div>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: ${progreso}%"></div></div>
                            <button class="btn-participar" onclick="abrirModalParticipar('${r.id}')" ${disponibles <= 0 ? 'disabled' : ''}>${disponibles <= 0 ? 'Agotada' : 'üéüÔ∏è Comprar Boletos'}</button>
                        </div>
                    </div>`;
            }).join('');
            
            actualizarTemporizadores();
        }

        function actualizarTemporizadores() {
            document.querySelectorAll('.rifa-timer').forEach(timer => {
                const rifaId = timer.dataset.id;
                const rifa = rifas.find(r => r.id === rifaId);
                if (!rifa) return;
                
                let fechaFin;
                if (rifa.fechaFin && rifa.fechaFin.toDate) {
                    fechaFin = rifa.fechaFin.toDate();
                } else if (rifa.fechaCreacion && rifa.dias) {
                    const fechaInicio = rifa.fechaCreacion.toDate ? rifa.fechaCreacion.toDate() : new Date(rifa.fechaCreacion);
                    fechaFin = new Date(fechaInicio.getTime() + (rifa.dias * 24 * 60 * 60 * 1000));
                } else {
                    timer.textContent = '‚è±Ô∏è Sin fecha';
                    return;
                }
                
                const ahora = new Date();
                const diff = fechaFin - ahora;
                
                if (diff <= 0) {
                    timer.textContent = '‚è±Ô∏è Finalizado';
                    return;
                }
                
                const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
                const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                if (dias > 0) {
                    timer.textContent = `‚è±Ô∏è ${dias}d ${horas}h`;
                } else {
                    timer.textContent = `‚è±Ô∏è ${horas}h ${minutos}m`;
                }
            });
        }

        async function cargarGanadores() {
            try {
                const snapshot = await db.collection('ganadores').orderBy('fecha', 'desc').limit(5).get();
                const lista = document.getElementById('ganadoresList');
                if (snapshot.empty) { lista.innerHTML = '<div class="empty-state"><span>üèÜ</span><p>Pr√≥ximamente ganadores</p></div>'; return; }
                lista.innerHTML = '';
                snapshot.forEach(doc => {
                    const g = doc.data();
                    lista.innerHTML += `<div class="ganador-item"><div class="ganador-icon">${g.icono || 'üèÜ'}</div><div class="ganador-info"><div class="ganador-nombre">${g.nombre}</div><div class="ganador-premio">Gan√≥: ${g.premio}</div></div></div>`;
                });
            } catch {}
        }

        // Compra
        function abrirModalParticipar(rifaId) {
            if (!currentUser) { mostrarToast('Inicia sesi√≥n para participar', 'error'); abrirModal('modalLogin'); return; }
            rifaSeleccionada = rifas.find(r => r.id === rifaId);
            if (!rifaSeleccionada) return;
            
            cantidadBoletos = 1;
            comprobanteFile = null;
            document.getElementById('modalParticiparTitle').textContent = `üéüÔ∏è ${rifaSeleccionada.titulo}`;
            document.getElementById('precioBoletoPaso1').textContent = `$${rifaSeleccionada.precioBoleto || 1} USD`;
            document.getElementById('pasoSeleccion').style.display = 'block';
            document.getElementById('pasoPago').style.display = 'none';
            document.getElementById('fileUploadZone').classList.remove('has-file');
            document.getElementById('fileUploadText').textContent = 'Click para subir imagen o PDF';
            document.getElementById('comprobantePreview').style.display = 'none';
            actualizarDisplayBoletos();
            abrirModal('modalParticipar');
        }

        function cambiarCantidadBoletos(delta) {
            const disponibles = rifaSeleccionada.totalBoletos - (rifaSeleccionada.boletosVendidos || 0);
            cantidadBoletos = Math.max(1, Math.min(cantidadBoletos + delta, disponibles, 100));
            actualizarDisplayBoletos();
        }

        function actualizarDisplayBoletos() {
            const precio = rifaSeleccionada.precioBoleto || 1;
            document.getElementById('cantidadBoletosDisplay').textContent = cantidadBoletos;
            document.getElementById('totalPagarBoletos').textContent = `$${(cantidadBoletos * precio).toFixed(2)}`;
        }

        function irPasoPago() {
            const precio = rifaSeleccionada.precioBoleto || 1;
            document.getElementById('montoPagar').textContent = `$${(cantidadBoletos * precio).toFixed(2)} USD`;
            document.getElementById('pasoSeleccion').style.display = 'none';
            document.getElementById('pasoPago').style.display = 'block';
        }

        function volverPasoSeleccion() {
            document.getElementById('pasoSeleccion').style.display = 'block';
            document.getElementById('pasoPago').style.display = 'none';
        }

        function previewComprobante(event) {
            const file = event.target.files[0];
            if (!file) return;
            comprobanteFile = file;
            document.getElementById('fileUploadZone').classList.add('has-file');
            document.getElementById('fileUploadText').textContent = file.name;
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('comprobantePreview').src = e.target.result;
                    document.getElementById('comprobantePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        async function enviarComprobante() {
            if (!comprobanteFile) { mostrarToast('Adjunta el comprobante', 'error'); return; }
            
            const btn = document.getElementById('btnEnviarComprobante');
            btn.disabled = true; btn.textContent = 'Enviando...';
            
            try {
                const precio = rifaSeleccionada.precioBoleto || 1;
                const total = cantidadBoletos * precio;
                const comisionPorBoleto = rifaSeleccionada.comisionesActivas ? (precio * (rifaSeleccionada.comisionPorcentaje || 10) / 100) : 0.10;
                
                // Subir comprobante
                const storageRef = storage.ref(`comprobantes/${currentUser.uid}/${Date.now()}_${comprobanteFile.name}`);
                await storageRef.put(comprobanteFile);
                const comprobanteUrl = await storageRef.getDownloadURL();
                
                // Crear compra pendiente
                await db.collection('compras').add({
                    usuarioId: currentUser.uid,
                    usuarioNombre: `${userData.nombre} ${userData.apellido}`,
                    usuarioEmail: userData.email,
                    rifaId: rifaSeleccionada.id,
                    rifaTitulo: rifaSeleccionada.titulo,
                    cantidad: cantidadBoletos,
                    precioUnitario: precio,
                    total: total,
                    comisionPorBoleto: comisionPorBoleto,
                    referidorId: userData.referidoPor || null,
                    comprobanteUrl: comprobanteUrl,
                    estado: 'pendiente',
                    fecha: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                cerrarModal('modalParticipar');
                mostrarToast('¬°Comprobante enviado! Espera aprobaci√≥n.', 'success');
            } catch (error) {
                console.error(error);
                mostrarToast('Error al enviar', 'error');
            }
            
            btn.disabled = false; btn.textContent = 'Enviar Comprobante';
        }

        // Perfil
        async function cambiarAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const storageRef = storage.ref(`avatars/${currentUser.uid}`);
                await storageRef.put(file);
                const url = await storageRef.getDownloadURL();
                await db.collection('usuarios').doc(currentUser.uid).update({ avatarUrl: url });
                userData.avatarUrl = url;
                actualizarUIUsuario();
                document.getElementById('profileAvatarContent').innerHTML = `<img src="${url}">`;
                mostrarToast('¬°Avatar actualizado!', 'success');
            } catch { mostrarToast('Error al subir', 'error'); }
        }

        async function actualizarPerfil(e) {
            e.preventDefault();
            try {
                await db.collection('usuarios').doc(currentUser.uid).update({
                    nombre: document.getElementById('editNombre').value.trim(),
                    apellido: document.getElementById('editApellido').value.trim(),
                    balanceEmail: document.getElementById('editBalanceEmail').value.trim() || null
                });
                await cargarDatosUsuario();
                actualizarUIUsuario();
                cerrarModal('modalPerfil');
                mostrarToast('¬°Perfil actualizado!', 'success');
            } catch { mostrarToast('Error', 'error'); }
        }

        // Modales Usuario
        function cargarModalPerfil() {
            if (!userData) return;
            document.getElementById('profileNombreCompleto').textContent = `${userData.nombre} ${userData.apellido}`;
            document.getElementById('profileEmail').textContent = userData.email;
            document.getElementById('editNombre').value = userData.nombre || '';
            document.getElementById('editApellido').value = userData.apellido || '';
            document.getElementById('editTelefono').value = userData.telefono || '';
            document.getElementById('editBalanceEmail').value = userData.balanceEmail || '';
            document.getElementById('profileAvatarContent').innerHTML = userData.avatarUrl ? `<img src="${userData.avatarUrl}">` : (userData.nombre ? userData.nombre.charAt(0).toUpperCase() : 'üë§');
        }

        async function cargarModalEstadisticas() {
            if (!currentUser) return;
            try {
                const comprasQuery = await db.collection('compras').where('usuarioId', '==', currentUser.uid).where('estado', '==', 'aprobado').get();
                let totalBoletos = 0, totalGastado = 0, rifasSet = new Set();
                comprasQuery.forEach(doc => {
                    const d = doc.data();
                    totalBoletos += d.cantidad || 0;
                    totalGastado += d.total || 0;
                    rifasSet.add(d.rifaId);
                });
                
                const premiosQuery = await db.collection('ganadores').where('usuarioId', '==', currentUser.uid).get();
                
                document.getElementById('statBoletosComprados').textContent = totalBoletos;
                document.getElementById('statDineroGastado').textContent = `$${totalGastado.toFixed(2)}`;
                document.getElementById('statRifasParticipadas').textContent = rifasSet.size;
                document.getElementById('statPremiosGanados').textContent = premiosQuery.size;
            } catch {}
        }

        function cambiarTabBoletos(tab, btn) {
            document.querySelectorAll('#modalMisBoletos .modal-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('listaMisBoletosAprobados').style.display = tab === 'aprobados' ? 'block' : 'none';
            document.getElementById('listaMisBoletospendientes').style.display = tab === 'pendientes' ? 'block' : 'none';
        }

        async function cargarModalMisBoletos() {
            if (!currentUser) return;
            
            const listaAprobados = document.getElementById('listaMisBoletosAprobados');
            const listaPendientes = document.getElementById('listaMisBoletospendientes');
            listaAprobados.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            listaPendientes.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                // Aprobados
                const aprobadosQuery = await db.collection('compras').where('usuarioId', '==', currentUser.uid).where('estado', '==', 'aprobado').get();
                if (aprobadosQuery.empty) {
                    listaAprobados.innerHTML = '<div class="empty-state"><span>üéüÔ∏è</span><p>No tienes boletos aprobados</p></div>';
                } else {
                    listaAprobados.innerHTML = '';
                    aprobadosQuery.forEach(doc => {
                        const c = doc.data();
                        const fecha = c.fecha?.toDate ? c.fecha.toDate().toLocaleDateString() : 'N/A';
                        listaAprobados.innerHTML += `<div class="ganador-item" style="border-color: var(--success);"><div class="ganador-icon">üéüÔ∏è</div><div class="ganador-info"><div class="ganador-nombre">${c.rifaTitulo}</div><div class="ganador-premio">${c.cantidad} boleto(s) - $${c.total} - ${fecha}</div></div><span class="status-badge status-approved">Aprobado</span></div>`;
                    });
                }
                
                // Pendientes
                const pendientesQuery = await db.collection('compras').where('usuarioId', '==', currentUser.uid).where('estado', '==', 'pendiente').get();
                if (pendientesQuery.empty) {
                    listaPendientes.innerHTML = '<div class="empty-state"><span>‚è≥</span><p>No tienes pagos pendientes</p></div>';
                } else {
                    listaPendientes.innerHTML = '';
                    pendientesQuery.forEach(doc => {
                        const c = doc.data();
                        const fecha = c.fecha?.toDate ? c.fecha.toDate().toLocaleDateString() : 'N/A';
                        listaPendientes.innerHTML += `<div class="ganador-item" style="border-color: var(--warning); background: rgba(255,167,38,0.1);"><div class="ganador-icon">‚è≥</div><div class="ganador-info"><div class="ganador-nombre">${c.rifaTitulo}</div><div class="ganador-premio">${c.cantidad} boleto(s) - $${c.total} - ${fecha}</div></div><span class="status-badge status-pending">Pendiente</span></div>`;
                    });
                }
            } catch (error) {
                console.error(error);
                listaAprobados.innerHTML = '<div class="empty-state"><span>‚ùå</span><p>Error al cargar</p></div>';
            }
        }

        async function cargarModalMisPremios() {
            if (!currentUser) return;
            const lista = document.getElementById('listaMisPremios');
            lista.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const premiosQuery = await db.collection('ganadores').where('usuarioId', '==', currentUser.uid).get();
                if (premiosQuery.empty) {
                    lista.innerHTML = '<div class="empty-state"><span>üèÜ</span><p>A√∫n no has ganado ning√∫n sorteo</p></div>';
                } else {
                    lista.innerHTML = '';
                    premiosQuery.forEach(doc => {
                        const p = doc.data();
                        const fecha = p.fecha?.toDate ? p.fecha.toDate().toLocaleDateString() : 'N/A';
                        lista.innerHTML += `<div class="ganador-item"><div class="ganador-icon">${p.icono || 'üèÜ'}</div><div class="ganador-info"><div class="ganador-nombre">${p.rifaTitulo || 'Sorteo'}</div><div class="ganador-premio">Premio: ${p.premio} - ${fecha}</div></div></div>`;
                    });
                }
            } catch { lista.innerHTML = '<div class="empty-state"><span>‚ùå</span><p>Error al cargar</p></div>'; }
        }

        async function cargarModalReferidos() {
            if (!userData) return;
            document.getElementById('miCodigoReferido').textContent = userData.codigoReferido || '------';
            try {
                const referidosQuery = await db.collection('usuarios').where('referidoPor', '==', currentUser.uid).get();
                document.getElementById('totalReferidos').textContent = referidosQuery.size;
                
                const comprasQuery = await db.collection('compras').where('referidorId', '==', currentUser.uid).where('estado', '==', 'aprobado').get();
                let totalBoletos = 0, totalDinero = 0;
                comprasQuery.forEach(doc => {
                    const d = doc.data();
                    totalBoletos += d.cantidad || 0;
                    totalDinero += (d.cantidad || 0) * (d.comisionPorBoleto || 0.10);
                });
                document.getElementById('boletosReferidos').textContent = totalBoletos;
                document.getElementById('dineroReferidos').textContent = `$${totalDinero.toFixed(2)}`;
            } catch {}
        }

        // Admin
        function mostrarPanelAdmin() {
            if (!userData || (userData.email !== ADMIN_EMAIL && !userData.esAdmin)) { mostrarToast('Sin permisos', 'error'); return; }
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('adminPanel').classList.add('active');
            document.getElementById('userDropdown').classList.remove('show');
            cargarDashboardAdmin();
        }

        function cerrarPanelAdmin() {
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('adminPanel').classList.remove('active');
        }

        function cambiarTabAdmin(tab, btn) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(c => c.style.display = 'none');
            btn.classList.add('active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).style.display = 'block';
            
            if (tab === 'dashboard') cargarDashboardAdmin();
            if (tab === 'rifas') cargarRifasAdmin();
            if (tab === 'usuarios') cargarUsuariosAdmin();
            if (tab === 'compras') cargarComprasAdmin();
            if (tab === 'pagos') cargarPagosAdmin();
        }

        async function cargarDashboardAdmin() {
            try {
                const [usuarios, rifas, compras, pagosPend] = await Promise.all([
                    db.collection('usuarios').get(),
                    db.collection('rifas').where('activa', '==', true).get(),
                    db.collection('compras').where('estado', '==', 'aprobado').get(),
                    db.collection('compras').where('estado', '==', 'pendiente').get()
                ]);
                
                let totalBoletos = 0, totalIngresos = 0, totalComisiones = 0;
                compras.forEach(doc => {
                    const d = doc.data();
                    totalBoletos += d.cantidad || 0;
                    totalIngresos += d.total || 0;
                    if (d.referidorId) totalComisiones += (d.cantidad || 0) * (d.comisionPorBoleto || 0.10);
                });
                
                document.getElementById('adminTotalUsuarios').textContent = usuarios.size;
                document.getElementById('adminTotalRifas').textContent = rifas.size;
                document.getElementById('adminTotalBoletos').textContent = totalBoletos;
                document.getElementById('adminTotalIngresos').textContent = `$${totalIngresos.toFixed(2)}`;
                document.getElementById('adminTotalComisiones').textContent = `$${totalComisiones.toFixed(2)}`;
                document.getElementById('adminPagosPendientes').textContent = pagosPend.size;
            } catch {}
        }

        async function cargarRifasAdmin() {
            const tbody = document.getElementById('rifasAdminBody');
            tbody.innerHTML = '<tr><td colspan="6"><div class="spinner" style="margin: 1rem auto;"></div></td></tr>';
            try {
                const snapshot = await db.collection('rifas').get();
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const r = { id: doc.id, ...doc.data() };
                    const tipoText = r.tipoPremio === 'dinero' ? 'üíµ' : r.tipoPremio === 'objeto' ? 'üéÅ' : '‚ú®';
                    tbody.innerHTML += `<tr>
                        <td>${r.icono || 'üéÅ'} ${r.titulo}</td>
                        <td>${tipoText} ${r.tipoPremio || 'dinero'}</td>
                        <td>${r.tipoPremio === 'dinero' ? '$' : ''}${r.premio}</td>
                        <td>${r.boletosVendidos || 0}/${r.totalBoletos}</td>
                        <td><span class="status-badge ${r.activa ? 'status-active' : 'status-inactive'}">${r.activa ? 'Activa' : 'Inactiva'}</span></td>
                        <td>
                            <button class="btn-small btn-edit" onclick="editarRifaAdmin('${r.id}')">Editar</button>
                            <button class="btn-small btn-toggle" onclick="toggleRifaAdmin('${r.id}', ${r.activa})">${r.activa ? 'Desact.' : 'Activar'}</button>
                            <button class="btn-small btn-delete" onclick="eliminarRifaAdmin('${r.id}')">Eliminar</button>
                        </td>
                    </tr>`;
                });
                if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay rifas</td></tr>';
            } catch {}
        }

        async function cargarUsuariosAdmin() {
            const tbody = document.getElementById('usuariosAdminBody');
            tbody.innerHTML = '<tr><td colspan="6"><div class="spinner" style="margin: 1rem auto;"></div></td></tr>';
            try {
                const snapshot = await db.collection('usuarios').get();
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const u = { id: doc.id, ...doc.data() };
                    tbody.innerHTML += `<tr>
                        <td>${u.nombre} ${u.apellido}</td>
                        <td>${u.email}</td>
                        <td>${u.telefono || 'N/A'}</td>
                        <td>${u.balanceEmail || 'No configurado'}</td>
                        <td>${u.totalReferidos || 0}</td>
                        <td><button class="btn-small btn-view" onclick="verUsuarioAdmin('${u.id}')">Ver</button></td>
                    </tr>`;
                });
            } catch {}
        }

        async function cargarComprasAdmin() {
            const tbody = document.getElementById('comprasAdminBody');
            tbody.innerHTML = '<tr><td colspan="6"><div class="spinner" style="margin: 1rem auto;"></div></td></tr>';
            try {
                const snapshot = await db.collection('compras').where('estado', '==', 'aprobado').get();
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const fecha = c.fecha?.toDate ? c.fecha.toDate().toLocaleDateString() : 'N/A';
                    tbody.innerHTML += `<tr>
                        <td>${c.usuarioNombre}</td>
                        <td>${c.rifaTitulo}</td>
                        <td>${c.cantidad}</td>
                        <td>$${c.total}</td>
                        <td><span class="status-badge status-approved">Aprobado</span></td>
                        <td>${fecha}</td>
                    </tr>`;
                });
                if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay compras</td></tr>';
            } catch {}
        }

        async function cargarPagosAdmin() {
            const tbody = document.getElementById('pagosAdminBody');
            tbody.innerHTML = '<tr><td colspan="7"><div class="spinner" style="margin: 1rem auto;"></div></td></tr>';
            try {
                const snapshot = await db.collection('compras').where('estado', '==', 'pendiente').get();
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const c = { id: doc.id, ...doc.data() };
                    const fecha = c.fecha?.toDate ? c.fecha.toDate().toLocaleDateString() : 'N/A';
                    tbody.innerHTML += `<tr>
                        <td>${c.usuarioNombre}</td>
                        <td>${c.rifaTitulo}</td>
                        <td>${c.cantidad}</td>
                        <td>$${c.total}</td>
                        <td><button class="btn-small btn-view" onclick="verComprobante('${c.comprobanteUrl}')">Ver</button></td>
                        <td>${fecha}</td>
                        <td>
                            <button class="btn-small btn-approve" onclick="aprobarPago('${c.id}')">‚úì Aprobar</button>
                            <button class="btn-small btn-reject" onclick="rechazarPago('${c.id}')">‚úó Rechazar</button>
                        </td>
                    </tr>`;
                });
                if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay pagos pendientes üéâ</td></tr>';
            } catch {}
        }

        function verComprobante(url) {
            document.getElementById('comprobanteViewer').src = url;
            abrirModal('modalVerComprobante');
        }

        async function aprobarPago(compraId) {
            if (!confirm('¬øAprobar este pago?')) return;
            try {
                const compraDoc = await db.collection('compras').doc(compraId).get();
                const compra = compraDoc.data();
                
                // Actualizar estado
                await db.collection('compras').doc(compraId).update({ estado: 'aprobado' });
                
                // Actualizar boletos vendidos en la rifa
                await db.collection('rifas').doc(compra.rifaId).update({
                    boletosVendidos: firebase.firestore.FieldValue.increment(compra.cantidad)
                });
                
                mostrarToast('¬°Pago aprobado!', 'success');
                cargarPagosAdmin();
                cargarDashboardAdmin();
                cargarRifas();
            } catch { mostrarToast('Error', 'error'); }
        }

        async function rechazarPago(compraId) {
            if (!confirm('¬øRechazar este pago?')) return;
            try {
                await db.collection('compras').doc(compraId).update({ estado: 'rechazado' });
                mostrarToast('Pago rechazado', 'success');
                cargarPagosAdmin();
            } catch { mostrarToast('Error', 'error'); }
        }

        async function verUsuarioAdmin(userId) {
            try {
                const userDoc = await db.collection('usuarios').doc(userId).get();
                const u = { id: userId, ...userDoc.data() };
                
                const comprasQuery = await db.collection('compras').where('usuarioId', '==', userId).get();
                
                let html = `
                    <div style="display: grid; gap: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">${u.avatarUrl ? `<img src="${u.avatarUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : u.nombre?.charAt(0) || 'üë§'}</div>
                            <div>
                                <h3>${u.nombre} ${u.apellido}</h3>
                                <p style="opacity: 0.7;">${u.email}</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <p><strong>Tel√©fono:</strong> ${u.telefono || 'N/A'}</p>
                            <p><strong>Referidos:</strong> ${u.totalReferidos || 0}</p>
                            <p><strong>Balance Email:</strong> ${u.balanceEmail || 'No configurado'}</p>
                            <p><strong>C√≥digo:</strong> ${u.codigoReferido}</p>
                        </div>
                        <h4 style="margin-top: 1rem;">Compras del Usuario</h4>
                        <table class="admin-table">
                            <thead><tr><th>Rifa</th><th>Boletos</th><th>Total</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody>`;
                
                comprasQuery.forEach(doc => {
                    const c = { id: doc.id, ...doc.data() };
                    html += `<tr>
                        <td>${c.rifaTitulo}</td>
                        <td>${c.cantidad}</td>
                        <td>$${c.total}</td>
                        <td><span class="status-badge status-${c.estado === 'aprobado' ? 'approved' : c.estado === 'pendiente' ? 'pending' : 'inactive'}">${c.estado}</span></td>
                        <td>${c.estado === 'aprobado' ? `<button class="btn-small btn-delete" onclick="reembolsarCompra('${c.id}', '${u.balanceEmail || ''}')">Reembolsar</button>` : '-'}</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div>`;
                
                document.getElementById('detalleUsuarioContent').innerHTML = html;
                abrirModal('modalVerUsuario');
            } catch { mostrarToast('Error al cargar', 'error'); }
        }

        async function reembolsarCompra(compraId, balanceEmail) {
            if (!balanceEmail) {
                mostrarToast('Usuario sin correo de balance configurado', 'error');
                return;
            }
            if (!confirm(`¬øReembolsar? El pago se enviar√° a: ${balanceEmail}`)) return;
            
            try {
                const compraDoc = await db.collection('compras').doc(compraId).get();
                const compra = compraDoc.data();
                
                await db.collection('compras').doc(compraId).update({ estado: 'reembolsado' });
                await db.collection('rifas').doc(compra.rifaId).update({
                    boletosVendidos: firebase.firestore.FieldValue.increment(-compra.cantidad)
                });
                
                mostrarToast(`Reembolso marcado. Enviar $${compra.total} a ${balanceEmail}`, 'success');
                cerrarModal('modalVerUsuario');
                cargarUsuariosAdmin();
                cargarRifas();
            } catch { mostrarToast('Error', 'error'); }
        }

        // Rifas Admin
        function toggleComisiones() {
            comisionesActivas = !comisionesActivas;
            document.getElementById('toggleComisiones').classList.toggle('active', comisionesActivas);
            document.getElementById('comisionesConfig').style.display = comisionesActivas ? 'block' : 'none';
        }

        function abrirModalNuevaRifa() {
            rifaEditando = null;
            comisionesActivas = false;
            document.getElementById('modalRifaTitle').textContent = '‚ûï Nueva Rifa';
            document.getElementById('toggleComisiones').classList.remove('active');
            document.getElementById('comisionesConfig').style.display = 'none';
            document.querySelector('#modalNuevaRifa form').reset();
            document.getElementById('rifaIcono').value = 'üéÅ';
            document.getElementById('rifaPremio').value = '100';
            document.getElementById('rifaPrecioBoleto').value = '1';
            document.getElementById('rifaTotalBoletos').value = '100';
            document.getElementById('rifaDias').value = '7';
            abrirModal('modalNuevaRifa');
        }

        async function editarRifaAdmin(id) {
            try {
                const doc = await db.collection('rifas').doc(id).get();
                const r = doc.data();
                rifaEditando = id;
                
                document.getElementById('modalRifaTitle').textContent = '‚úèÔ∏è Editar Rifa';
                document.getElementById('rifaTitulo').value = r.titulo;
                document.getElementById('rifaDescripcion').value = r.descripcion || '';
                document.getElementById('rifaIcono').value = r.icono || 'üéÅ';
                document.getElementById('rifaTipoPremio').value = r.tipoPremio || 'dinero';
                document.getElementById('rifaPremio').value = r.premio;
                document.getElementById('rifaPrecioBoleto').value = r.precioBoleto || 1;
                document.getElementById('rifaTotalBoletos').value = r.totalBoletos;
                document.getElementById('rifaDias').value = r.dias || 7;
                
                comisionesActivas = r.comisionesActivas || false;
                document.getElementById('toggleComisiones').classList.toggle('active', comisionesActivas);
                document.getElementById('comisionesConfig').style.display = comisionesActivas ? 'block' : 'none';
                document.getElementById('rifaComisionPorcentaje').value = r.comisionPorcentaje || 10;
                
                abrirModal('modalNuevaRifa');
            } catch {}
        }

        async function guardarRifa(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Guardando...';
            
            try {
                let imagenUrl = null;
                const imagenFile = document.getElementById('rifaImagen').files[0];
                if (imagenFile) {
                    const storageRef = storage.ref(`rifas/${Date.now()}_${imagenFile.name}`);
                    await storageRef.put(imagenFile);
                    imagenUrl = await storageRef.getDownloadURL();
                }
                
                const datos = {
                    titulo: document.getElementById('rifaTitulo').value,
                    descripcion: document.getElementById('rifaDescripcion').value,
                    icono: document.getElementById('rifaIcono').value,
                    tipoPremio: document.getElementById('rifaTipoPremio').value,
                    premio: document.getElementById('rifaPremio').value,
                    precioBoleto: parseFloat(document.getElementById('rifaPrecioBoleto').value),
                    totalBoletos: parseInt(document.getElementById('rifaTotalBoletos').value),
                    dias: parseInt(document.getElementById('rifaDias').value),
                    comisionesActivas: comisionesActivas,
                    comisionPorcentaje: comisionesActivas ? parseInt(document.getElementById('rifaComisionPorcentaje').value) : 0
                };
                
                if (imagenUrl) datos.imagenUrl = imagenUrl;
                
                if (rifaEditando) {
                    await db.collection('rifas').doc(rifaEditando).update(datos);
                } else {
                    datos.boletosVendidos = 0;
                    datos.activa = true;
                    datos.finalizada = false;
                    datos.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
                    datos.fechaFin = new Date(Date.now() + datos.dias * 24 * 60 * 60 * 1000);
                    await db.collection('rifas').add(datos);
                }
                
                cerrarModal('modalNuevaRifa');
                rifaEditando = null;
                cargarRifasAdmin();
                cargarRifas();
                mostrarToast('Rifa guardada', 'success');
            } catch { mostrarToast('Error', 'error'); }
            
            btn.disabled = false; btn.textContent = 'Guardar Rifa';
        }

        async function toggleRifaAdmin(id, activa) {
            await db.collection('rifas').doc(id).update({ activa: !activa });
            cargarRifasAdmin();
            cargarRifas();
        }

        async function eliminarRifaAdmin(id) {
            if (!confirm('¬øEliminar rifa?')) return;
            await db.collection('rifas').doc(id).delete();
            cargarRifasAdmin();
            cargarRifas();
        }

        // Utils
        function abrirModal(id) {
            document.getElementById(id).classList.add('active');
            if (id === 'modalPerfil') cargarModalPerfil();
            if (id === 'modalEstadisticas') cargarModalEstadisticas();
            if (id === 'modalMisBoletos') cargarModalMisBoletos();
            if (id === 'modalMisPremios') cargarModalMisPremios();
            if (id === 'modalReferidos') cargarModalReferidos();
        }

        function cerrarModal(id) {
            document.getElementById(id).classList.remove('active');
            if (id === 'modalNuevaRifa') rifaEditando = null;
        }

        function cambiarModal(cerrar, abrir) {
            cerrarModal(cerrar);
            setTimeout(() => abrirModal(abrir), 200);
        }

        function toggleUserDropdown() {
            event.stopPropagation();
            document.getElementById('userDropdown').classList.toggle('show');
        }

        function irInicio() {
            cerrarPanelAdmin();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function mostrarToast(msg, tipo = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `<span>${tipo === 'success' ? '‚úÖ' : '‚ùå'}</span> ${msg}`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3500);
        }

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
        });

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href'))?.scrollIntoView({ behavior: 'smooth' });
            });
        });
    </script>
</body>
</html>
